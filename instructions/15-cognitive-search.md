---
lab:
  title: Azure AI 検索と Azure Cosmos DB for NoSQL を使用してデータを検索する
  module: Module 7 - Integrate Azure Cosmos DB for NoSQL with Azure services
---

# Azure AI 検索と Azure Cosmos DB for NoSQL を使用してデータを検索する

Azure AI 検索は、サービスとしての検索エンジンを AI 機能との深い統合と組み合わせて、検索インデックスの情報をエンリッチします。

このラボでは、Azure Cosmos DB for NoSQL コンテナー内のデータに自動的にインデックスを付け、そのデータを Azure Cognitive Services Translator 機能を使用してエンリッチする Azure AI 検索インデックスを構築します。

## Azure Cosmos DB for NoSQL アカウントを作成する

Azure Cosmos DB は、複数の API をサポートするクラウドベースの NoSQL データベース サービスです。 Azure Cosmos DB アカウントを初めてプロビジョニングするときに、そのアカウントでサポートする API (たとえば、**Mongo API** や **NoSQL API**) を選択します。 Azure Cosmos DB for NoSQL アカウントのプロビジョニングが完了したら、エンドポイントとキーを取得し、Azure SDK for .NET または任意の他の SDK を使用して Azure Cosmos DB for NoSQL アカウントに接続する際に使用できます。

1. 新しい Web ブラウザー ウィンドウまたはタブで、Azure portal (``portal.azure.com``) に移動します。

1. ご利用のサブスクリプションに関連付けられている Microsoft 資格情報を使用して、ポータルにサインインします。

1. **[+ リソースの作成]** を選択し、*Cosmos DB* を検索して、新しい **Azure Cosmos DB for NoSQL** アカウント リソースを作成します。以下を設定して、残りの設定はすべて既定値のままにします。

    | **設定** | **Value** |
    | ---: | :--- |
    | **ワークロードの種類** | **学習** |
    | **サブスクリプション** | ''*既存の Azure サブスクリプション*'' |
    | **リソース グループ** | ''*既存のリソース グループを選択するか、新しいものを作成します*'' |
    | **アカウント名** | ''*グローバルに一意の名前を入力します*'' |
    | **場所** | ''*使用可能なリージョンを選びます*'' |
    | **容量モード** | *プロビジョニング済みスループット* |
    | **Apply Free Tier Discount (Free レベル割引の適用)** | *適用しない* |

    > &#128221; ご利用のラボ環境には、新しいリソース グループを作成できない制限が存在する場合があります。 その場合は、事前に作成されている既存のリソース グループを使用します。

1. デプロイ タスクが完了するまで待ってから、このタスクを続行してください。

1. 新しく作成された **Azure Cosmos DB** アカウント リソースに移動し、 **[キー]** ペインに移動します。

1. このペインには、SDK からアカウントに接続するために必要な接続の詳細と資格情報が含まれています。 具体的な内容は次のとおりです。

    1. [**プライマリ接続文字列**] フィールドに注目します。 この**接続文字列**の値は、この演習で後ほど使用します。

1. リソース メニューで **[データ エクスプローラー]** を選択します。

1. **[データ エクスプローラー]** ペインで、**[新しいコンテナー]** を展開してから、**[新しいデータベース]** を選択します。

1. **[新しいデータベース]** ポップアップで、各設定に次の値を入力してから **[OK]** を選択します。

    | **設定** | **Value** |
    | --: | :-- |
    | **データベース ID** | *``cosmicworks``* |
    | **スループットのプロビジョニング** | 有効 |
    | **データベースのスループット** | **[手動]** |
    | **データベースに必要な RU/秒** | ``1000`` |

1. **[データ エクスプローラー]** ペインに戻り、階層内の **cosmicworks** データベース ノードを確認します。

1. **[データ エクスプローラー]** ペインで、 **[新しいコンテナー]** を選択します。

1. **[新しいコンテナー]** ポップアップで、各設定に次の値を入力してから **[OK]** を選択します。

    | **設定** | **Value** |
    | --: | :-- |
    | **データベース ID** | ''*既存の* &vert; *cosmicworks を使用します*'' |
    | **コンテナー ID** | *``products``* |
    | **パーティション キー** | *``/category/name``* |

1. **[データ エクスプローラー]** ペインに戻り、**cosmicworks** データベース ノードを展開して、階層内の **products** コンテナー ノードを確認します。

## Azure Cosmos DB for NoSQL アカウントにサンプル データをシードする

**cosmicworks** データベースと **products** コンテナーを作成するコマンドライン ユーティリティを使用します。

1. **Visual Studio Code** で、[**ターミナル**] メニューを開き、[**新しいターミナル**] を選択します。

1. [cosmicworks][nuget.org/packages/cosmicworks] コマンドライン ツールをインストールして、マシンにグローバルに使用できるようにします。

    ```
    dotnet tool install --global CosmicWorks --version 2.3.1
    ```

    > &#128161; このコマンドが完了するまで数分かかる場合があります。 過去にこのツールの最新バージョンを既にインストールしている場合は、このコマンドによって警告メッセージ (*ツール 'cosmicworks' は既にインストールされています) が出力されます。

1. cosmicworks を実行し、次のコマンドライン オプションを使用して Azure Cosmos DB アカウントをシードします。

    | **オプション** | **Value** |
    | ---: | :--- |
    | **-c** | *このラボで先ほど確認した接続文字列の値* |
    | **--number-of-employees** | *特に指定がない限り、cosmicworks コマンドは、従業員 1000 人と製品コンテナー 200 項目をデータベースに入力します* |

    ```powershell
    cosmicworks -c "connection-string" --number-of-employees 0 --disable-hierarchical-partition-keys
    ```

    > &#128221; たとえば、エンドポイントが **https&shy;://dp420.documents.azure.com:443/** で、キーが **fDR2ci9QgkdkvERTQ==** の場合、コマンドは次のようになります。``cosmicworks -c "AccountEndpoint=https://dp420.documents.azure.com:443/;AccountKey=fDR2ci9QgkdkvERTQ==" --number-of-employees 0 --disable-hierarchical-partition-keys``

1. **cosmicworks** コマンドによって、データベース、コンテナー、および項目がアカウントに設定されるまで待ちます。

1. 統合ターミナルを閉じます。

1. **Visual Studio Code** を閉じます。

## "Azure AI 検索" リソースを作成する

この演習を続行するには、まず新しい Azure AI 検索インスタンスを作成する必要があります。

1. 新しい Web ブラウザー ウィンドウまたはタブで、Azure portal (``portal.azure.com``) に移動します。

1. ご利用のサブスクリプションに関連付けられている Microsoft 資格情報を使用して、ポータルにサインインします。

1. **[+ リソースの作成]** を選択し、*AI 検索*を検索した後、新しい **Azure AI 検索**アカウント リソースを、以下の設定で作成します。残りの設定はすべて既定値のままにします。

    | **設定** | **Value** |
    | ---: | :--- |
    | **サブスクリプション** | ''*既存の Azure サブスクリプション*'' |
    | **リソース グループ** | ''*既存のリソース グループを選択するか、新しいものを作成します*'' |
    | **名前** | ''*グローバルに一意の名前を入力します*'' |
    | **場所** | ''*使用可能なリージョンを選びます*'' |

    > &#128221; ご利用のラボ環境には、新しいリソース グループを作成できない制限が存在する場合があります。 その場合は、事前に作成されている既存のリソース グループを使用します。

1. デプロイ タスクが完了するまで待ってから、このタスクを続行してください。

1. 新しく作成された **Azure AI 検索**アカウント リソースに移動します。

## Azure Cosmos DB for NoSQL データ用にインデクサーとインデックスを作成する

特定の Azure Cosmos DB for NoSQL コンテナー内のデータのサブセットに 1 時間ごとにインデックスを付けるインデクサーを作成します。

1. **[AI 検索]** リソース ブレードから、**[データのインポート]** を選択します。

1. **[データのインポート]** ウィザードの **[データへの接続]** の手順で、**[データ ソース]** リストで **[Azure Cosmos DB]** を選択します。

1. 次の設定でデータ ソースを構成し、残りのすべての設定を既定値のままにします。

    | **設定** | **Value** |
    | ---: | :--- |
    | **[データ ソース名]** | *``products-cosmossql-source``* |
    | **接続文字列** | "*先ほど作成した Azure Cosmos DB for NoSQL アカウントの**接続文字列***" |
    | **データベース** | *cosmicworks* |
    | **コレクション** | *products* |

1. **[クエリ]** フィールドに、次の SQL クエリを入力して、コンテナーにあるデータのサブセットの具体化されたビューを作成します。

    ```sql
    SELECT 
        p.id, 
        p.category, 
        p.name, 
        p.price,
        p._ts
    FROM 
        products p 
    WHERE 
        p._ts > @HighWaterMark 
    ORDER BY 
        p._ts
    ```

1. **[_ts によって並べ替えられたクエリ結果]** チェックボックスを選択します。

    > &#128221; このチェックボックスにより、Azure AI 検索に、クエリが **[_ts]** フィールドで結果をソートすることを知らせることができます。 この種類の並べ替えでは、進行状況の追跡を段階的に実行できます。 結果はタイムスタンプ順に並べられているため、インデクサーは失敗した場合でも、同じ **_ts** 値からすぐに正しいバックアップを取得することができます。

1. **[次へ: コグニティブ スキルの追加]** を選択します。

1. **[スキップ先: 対象インデックスをカスタマイズします]** を選びます。

1. ウィザードの **[対象インデックスをカスタマイズします]** の手順で、次の設定を使用してインデックスを構成し、残りのすべての設定を既定値のままにします。

    | **設定** | **Value** |
    | ---: | :--- |
    | **[インデックス名]** | *``products-index``* |
    | **[キー]** | *id* |

1. フィールド テーブルで、次のテーブルを使用したフィールドごとに **[取得可能]**、**[フィルター可能]**、**[ソート可能]**、**[ファセット可能]**、および **[検索可能]** オプションをそれぞれ構成します。

    | **フィールド** | **取得可能** | **フィルター可能** | **ソート可能** | **ファセット可能** | **検索可能** |
    | ---: | :---: | :---: | :---: | :---: | :---: |
    | **id** | &#10004; | &#10004; | &#10004; | | |
    | **category** | &#10004; | &#10004; | &#10004; | &#10004; | |
    | **name** | &#10004; | &#10004; | &#10004; | | &#10004; (英語 - Microsoft) |
    | **Price** | &#10004; | &#10004; | &#10004; | &#10004; | |

1. **[次へ: インデクサーの作成]** を選択します。

1. ウィザードの **[インデクサーの作成]** の手順で、次の設定を使用してインデクサーを構成し、残りのすべての設定を既定値のままにします。

    | **設定** | **Value** |
    | ---: | :--- |
    | **名前** | *``products-cosmosdb-indexer``* |
    | **[スケジュール]** | *1 時間ごと* |

1. **[送信]** を選択して、データ ソース、インデックス、およびインデクサーを作成します。

    > &#128221; 最初のインデクサーを作成した後、アンケートのポップアップを閉じる必要がある場合があります。

1. **[AI 検索]** リソース ブレードから、**[インデクサー]** タブに移動して、最初のインデックス作成操作の結果を確認します。

1. このタスクを続行する前に、**products-cosmosdb-indexer** インデクサーの状態が **Success** になるのを待ちます。

    > &#128221; ブレードが自動的に更新されない場合は、**[更新]** オプションを使用してブレードを更新しなければならない場合があります。

1. **[インデックス]** タブに移動し、**products-index**インデックスを選択します。

## 検索クエリの例を使用したインデックスの検証

これで、Azure Cosmos DB for NoSQL データの具体化されたビューが検索インデックスに含まれるようになったため、Azure AI 検索の機能を利用するいくつかの基本的なクエリを実行できます。

> &#128221; このラボは、Azure AI 検索の構文を説明するためのものではありません。 これらのクエリは、検索インデックスとエンジンで利用可能な機能の一部を紹介するためにキュレーションされました。

1. **[検索エクスプローラー]** タブで、**[ビュー]** プルダウンを選択してから、**[JSON ビュー]** を選択します。

1. **JSON クエリ エディター**内の **\*** (ワイルドカード) 演算子を使用して考えられるすべての結果を返す既定の JSON 検索クエリの構文に注目してください。

   ```json
    {
      "search": "*",
      "count": true
    }
   ```

1. **[検索]** ボタンを選択して検索を実行します。

1. この検索クエリでは、可能性のあるすべての結果を返しますが、必ずしもすべてが同じページに含まれていない場合でも、結果の総数を示すメタデータ フィールドも含んでいることに注意してください。

1. **JSON クエリ エディター**に、次のクエリを入力した後、**[検索]** を選択します。

    ```json
    {
        "search": "touring 3000"
    }
    ```

1. この検索クエリは、**touring** または **3000** のいずれかの語句を含む結果を返し、両方の語句を含む結果により高いスコアを与えていることに注意してください。 次に、結果は **@search.score** フィールドの降順で並べ替えられます。

1. **JSON クエリ エディター**に、次のクエリを入力した後、**[検索]** を選択します。

    ```json
    {
        "search": "blue"
        , "count": true
        , "top": 6
    }
    ```

1. この検索クエリでは、サーバー側に一致するものが多い場合でも、一度に返されるのは 6 つの結果セットのみであることに注意してください。

1. **JSON クエリ エディター**に、次のクエリを入力した後、**[検索]** を選択します。

    ```json
    {
        "search": "mountain"
        , "count": true
        , "top": 25
        , "skip": 50
    }
    ```

1. この検索クエリでは最初の 50 件の結果がスキップされ、25 件の結果セットが返されることに注意してください。 これがクライアント側アプリケーションのページ分割されたビューである場合、これが結果の 3 番目の "ページ" になると推測できます。

1. **JSON クエリ エディター**に、次のクエリを入力した後、**[検索]** を選択します。

    ```json
    {
        "search": "touring"
        , "count": true
        , "filter": "price lt 500"
    }
    ```

1. この検索クエリでは、数値価格フィールドの値が 500 未満の場合にのみ結果が返されることに注意してください。

1. **JSON クエリ エディター**に、次のクエリを入力した後、**[検索]** を選択します。

    ```json
    {
        "search": "road"
        , "count": true
        , "top": 15
        , "facets": ["price,interval:500"]
    }
    ```

1. この検索クエリでは、結果の現在のページにすべてが存在しない場合でも、各カテゴリに属する項目の数を示すファセット データのコレクションが返されることに注意してください。 この例では、一致する項目が 500 の間隔で数値価格カテゴリに分類されています。 これは通常、クライアント側アプリケーションのフィルターおよびナビゲーション補助を設定するために使用されます。

1. Web ブラウザーのウィンドウまたはタブを閉じます。

[code.visualstudio.com/docs/getstarted]: https://code.visualstudio.com/docs/getstarted/tips-and-tricks
